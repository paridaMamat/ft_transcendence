{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcendence</title>
    <!-- Lien CDN pour Bootstrap CSS -->
    <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"> -->
    <!-- Lien CDN pour animate.css -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> -->
    <link rel="stylesheet" href="{% static 'css/start_AI.css' %}">
    <!-- <script>
        function demarrerJeu() {
            console.log("Préparation du jeu...");
            var i = 0;
            var interval = setInterval(function() {
              if (i >= 5) {
                clearInterval(interval);
                window.location.href = 'Pong-Game/AI3D.html'; // URL de votre jeu
              } else {
                var rect = document.createElement('div');
                rect.className = 'rectangle';
                document.getElementById('loadingBar').appendChild(rect);
                setTimeout(function() { rect.style.opacity = 1; }, 100);
              }
              i++;
            }, 1000);
          }
        </script> -->
</head>
<body>
  <header class="header">
    <ul id="menu-demo2">from django.shortcuts import render
      from django.http import HttpResponse, JsonResponse
      from django.contrib.auth import login, authenticate
      from rest_framework.response import Response
      from rest_framework import status
      from .forms import CustomUserCreationForm, CustomUserUpdateForm
      from .models import CustomUser
      from rest_framework.permissions import AllowAny
      from .serializers import *
      from .utils import get_tokens_for_user
      from rest_framework.decorators import api_view, permission_classes
      import requests
      from django.conf import settings
      import random
      import string
      import json
      
      def get_user_data_from_code(code, request):
          token_url = 'https://api.intra.42.fr/oauth/token'
          data = {
              'grant_type': 'authorization_code',
              'client_id': settings.CLIENT_ID,
              'client_secret': settings.CLIENT_SECRET,
              'code': code,
              'redirect_uri': settings.REDIRECT_URI,
          }
      
          try:
              response = requests.post(token_url, data=data)
              response.raise_for_status()
          except requests.exceptions.RequestException as e:
              return HttpResponse(f"Error: Unable to retrieve tokens. Details: {str(e)}", status=500)
          
          tokens = response.json()
          access_token = tokens.get('access_token')
          refresh_token = tokens.get('refresh_token')
      
          request.session['access_token'] = access_token
          request.session['refresh_token'] = refresh_token
      
          user_info_url = 'https://api.intra.42.fr/v2/me'
          headers = {'Authorization': f'Bearer {access_token}'}
      
          try:
              user_info_response = requests.get(user_info_url, headers=headers)
              user_info_response.raise_for_status()
          except requests.exceptions.RequestException as e:
              return HttpResponse(f"Error: Unable to retrieve user info. Details: {str(e)}", status=500)
          
          user_info = user_info_response.json()
          avatar_url = user_info.get('image', {}).get('link')  # Get the main avatar link
          
          # Log user info and avatar URL
          print(f"User Info: {user_info}")
          print(f"Avatar URL: {avatar_url}")
          
          return {
              'username': user_info.get('login'),
              'email': user_info.get('email'),
              'first_name': user_info.get('first_name'),
              'last_name': user_info.get('last_name'),
              'avatar_url': avatar_url
          }
      
      @api_view(['GET'])
      @permission_classes([AllowAny])
      def handle_42_redirect(request):
          code = request.GET.get('code')
          if not code:
              return HttpResponse("Error: No code provided", status=400)
          
          user_data = get_user_data_from_code(code, request)
          if isinstance(user_data, HttpResponse):
              return user_data
      
          username = user_data.get('username')
          email = user_data.get('email')
          first_name = user_data.get('first_name')
          last_name = user_data.get('last_name')
          avatar_url = user_data.get('avatar_url')
      
          print(f"Received user data: {user_data}")
      
          user = CustomUser.objects.filter(username=username).first()
          if not user:
              default_password = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
              
              # Download and save the avatar
              avatar_content = None
              if avatar_url:
                  print(f"Downloading avatar from {avatar_url}")
                  avatar_content = download_image(avatar_url)
                  if not avatar_content:
                      print("Failed to download avatar.")
              
              form_data = {
                  'username': username,
                  'email': email,
                  'first_name': first_name,
                  'last_name': last_name,
                  'password1': default_password,
                  'password2': default_password,
              }
              form = CustomUserCreationForm(form_data)
              if form.is_valid():
                  user = form.save(commit=False)
                  user.set_password(default_password)
                  if avatar_content:
                      avatar_filename = get_image_filename(avatar_url, username)
                      user.avatar.save(avatar_filename, avatar_content)
                  user.save()
              else:
                  return Response({'error': form.errors}, status=status.HTTP_400_BAD_REQUEST)
          else:
              # Update user details and avatar if needed
              form_data = {
                  'username': username,
                  'email': email,
                  'first_name': first_name,
                  'last_name': last_name,
                  'avatar': user.avatar  # Keep current avatar if not updating
              }
              form = CustomUserUpdateForm(form_data, instance=user)
              
              if avatar_url:
                  print(f"Updating avatar for user {username}")
                  avatar_content = download_image(avatar_url)
                  if avatar_content:
                      avatar_filename = get_image_filename(avatar_url, username)
                      user.avatar.save(avatar_filename, avatar_content)
                  else:
                      print("Failed to update avatar.")
              
              if form.is_valid():
                  form.save()
              else:
                  return Response({'error': form.errors}, status=status.HTTP_400_BAD_REQUEST)
      
              default_password = None
      
          if default_password:
              user = authenticate(username=username, password=default_password)
          else:
              # Existing user, attempt to authenticate without password
              user = CustomUser.objects.get(username=username)
      
          if not user:
              return Response({'error': 'Authentication failed'}, status=status.HTTP_400_BAD_REQUEST)
      
          login(request, user)
          tokens = get_tokens_for_user(user)
          return render(request, 'auth42.html', {
              'success': True,
              'message': 'Tokens generated successfully.',
              'tokens': json.dumps(tokens)  # Ensure tokens are serialized to JSON
          })
      
      
      '''@api_view(['GET'])
      @permission_classes([AllowAny])
      def handle_42_redirect(request):
          code = request.GET.get('code')
          if not code:
              return HttpResponse("Error: No code provided", status=400)
          
          user_data = get_user_data_from_code(code, request)
          if isinstance(user_data, HttpResponse):
              return user_data
      
          username = user_data.get('username')
          email = user_data.get('email')
          first_name = user_data.get('first_name')
          last_name = user_data.get('last_name')
          avatar_url = user_data.get('avatar_url')
      
          print(f"Received user data: {user_data}")
      
          user = CustomUser.objects.filter(username=username).first()
          if not user:
              default_password = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
              form_data = {
                  'username': username,
                  'email': email,
                  'first_name': first_name,
                  'last_name': last_name,
                  'password1': default_password,
                  'password2': default_password,
                  'avatar': avatar_url
              }
              form = CustomUserCreationForm(form_data)
              if form.is_valid():
                  user = form.save()
                  user.set_password(default_password)
      
                  # Download and save the avatar
                  if avatar_url:
                      print(f"Downloading avatar from {avatar_url}")
                      avatar_content = download_image(avatar_url)
                      if avatar_content:
                          avatar_filename = get_image_filename(avatar_url, username)
                          user.avatar.save(avatar_filename, avatar_content)
                      else:
                          print("Failed to download avatar.")
      
                  user.save()
              else:
                  return Response({'error': form.errors}, status=status.HTTP_400_BAD_REQUEST)
          else:
              default_password = None
      
          if default_password:
              user = authenticate(username=username, password=default_password)
          else:
              # Existing user, attempt to authenticate without password
              user = CustomUser.objects.get(username=username)
      
          if not user:
              return Response({'error': 'Authentication failed'}, status=status.HTTP_400_BAD_REQUEST)
      
          login(request, user)
          tokens = get_tokens_for_user(user)
          return render(request, 'auth42.html', {
              'success': True,
              'message': 'Tokens generated successfully.',
              'tokens': json.dumps(tokens)  # Ensure tokens are serialized to JSON
          })'''
        <li><a href="#">Languages</a>
            <ul>
                <li><a href="/fr/">Français</a></li>
                <li><a href="/en/">English</a></li>
                <li><a href="/ug/">ئۇيغۇرچە</a></li>
                <li><a href="/ar/">العربية</a></li>
            </ul>
        </li>
        <li><a href="#">Deconnexion</a>
        </li>
        </ul>
</header>
  <video id="video-bg" autoplay muted loop>
    <source src="{% static 'videos/video.mp4' %}" type="video/mp4">
  <source src="{% static 'videos/video.webm' %}" type="video/webm">
    Your browser does not support the video tag.
</video>
<!-- Titre en haut de la page -->
<div class="container">

    <!-- a changer -->
    <button onclick="demarrerJeu()" class="button">{% trans "Demarrer" %}</button>
    <div id="loadingBar"></div>

</div>
<div class="footer">
  <p>&copy; ft_transcendence 2024 </p>
</div>
<div class="sidebar" id="mySidebar">
  <div class="avatar-container">
      <a href="#profil">
          <img id="avatar" src="{{ request.user.avatar.url }}" alt="User Avatar" class="avatar">
      </a>
      <span id="userLogin" class="username">{{ request.user.username }}</span>  
  </div>
  <div class="links-container">
      <a href="#accueil" class="auth-link">
          <i class="fas fa-home"></i>  Accueil 
      
      </a>
      <a href="#games_page" class="auth-link">
          <i class="fas fa-gamepad"></i>  Jeux 
      
      </a>
      <a href="#account_settings" class="auth-link">
          <i class="fas fa-cogs"></i>  Parametres
      
      </a>
      <a href="#friends" class="auth-link">
          <i class="fas fa-user-tie"></i> Friends     
      </a>
      <a href="#about_us" class="auth-link">
          <i class="fas fa-info-circle"></i>  À propos 
        
      </a>
</div>
<!-- Lien CDN pour Bootstrap JS (Optionnel, si vous avez besoin de fonctionnalités JavaScript de Bootstrap) -->
<!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script> -->

</body>
</html>